---
title: "How many tree species in French Guiana Tropical Moist Forest?"
author:
  - name: "Eric Marcon"
  - name: "Ariane Mirabel"
  - name: "Jean-François Molino"
  - name: "Grégoire Vincent"
  - name: "Daniel Sabatier"
abstract: >
  The biodiversity of tropical rainforest is difficult to assess. 
  Yet, its estimation is necessary for conservation purposes, to evaluate our level of knowledge and the risks faced by the forest in relation to global change. Our contribution is to estimate the regional richness of tree species from local but widely spread inventories.
  Guyadiv is a network of forest plots installed over the whole territory of French Guiana, where trees over 10 cm DBH are identified. We use its information (1180 species censused in 76 one-hectare plots) to estimate the exponent of the species-area relationship, assuming Arrhenius’s power law. 
  We can then extrapolate the number of species from a local, wide inventory (62.5 ha in Paracou research station).
  We evaluate the number of tree species around 2000 over the territory.
date: "`r format(Sys.time(), '%d %B %Y')`"
url: https://GitHubID.github.io/Repository/
github-repo: GitHubID/Repository
lang: en-US
bibliography: references.bib
biblio-style: chicago
preamble: >
  \hyphenation{bio-di-ver-si-ty sap-lings}
pdftoc: false
toc-depth: 3
always_allow_html: yes
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
  rmdformats::downcute:
    use_bookdown: yes
    lightbox: yes
  bookdown::word_document2: default
  bookdown::gitbook:
    config:
      download: "pdf"
      sharing:
        github: yes
  bookdown::pdf_book:
    template: latex/template.tex
    citation_package: natbib
    latex_engine: xelatex
    keep_tex: yes
---

```{r DoNotModify, include=FALSE}
### Utilities. Do not modify.
# Installation of packages if necessary
InstallPackages <- function(Packages) {
  InstallPackage <- function(Package) {
    if (!Package %in% installed.packages()[, 1]) {
      install.packages(Package, repos="https://cran.rstudio.com/")
    }
  }
  invisible(sapply(Packages, InstallPackage))
}

# Basic packages
InstallPackages(c("bookdown", "formatR", "kableExtra", "ragg"))

# kableExtra must be loaded 
if (knitr::opts_knit$get("rmarkdown.pandoc.to") == "docx") {
  # Word output (https://stackoverflow.com/questions/35144130/in-knitr-how-can-i-test-for-if-the-output-will-be-pdf-or-word)
  # Do not use autoformat (https://github.com/haozhu233/kableExtra/issues/308)
  options(kableExtra.auto_format = FALSE)
}
library("kableExtra")

# Chunk font size hook: allows size='small' or any valid Latex font size in chunk options
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
```

```{r Options, include=FALSE}
### Customized options for this document
# Add necessary packages here
Packages <- c("ade4", "broom", "dbmss", "entropart", "secret", "tidyverse")
# Install them
InstallPackages(Packages)

# knitr options
knitr::opts_chunk$set(
  cache=TRUE, # Cache chunk results
  echo=FALSE, # Show/Hide R chunks
  warning=FALSE, # Show/Hide warnings
  messages=FALSE, # Show/Hide messages
  # Figure alignment and size
  fig.align='center', out.width='80%',
  # Graphic devices (ragg_png is better than standard png)
  dev = c("ragg_png", "pdf"),
  # Code chunk format
  tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=50),
  size="scriptsize", knitr.graphics.auto_pdf=TRUE
  )
options(width=50)

# ggplot style
library("tidyverse")
theme_set(theme_bw())
theme_update(panel.background=element_rect(fill="transparent", colour=NA),
             plot.background=element_rect(fill="transparent", colour=NA))
knitr::opts_chunk$set(dev.args=list(bg="transparent"))

# Random seed
set.seed(973)
```

# Introduction

Biodiversity assessment in tropical moist forests is a practical challenge but a major goal considering they are the most diverse terrestrial ecosystems.
Estimating the number of tree species is made possible by the long-term effort of sampling resulting in thousands of forest plots organized in various networks. 
In French Guiana, the Guyadiv network consists of close to 250 plots across the whole forest.
Based on similar datasets, the diversity of tree species has been estimated in Amazonia [@TerSteege2013; @TerSteege2020] and at the world scale [@Slik2015].
The methods used in those studies are not appropriate to estimate regional diversity, i.e. at a smaller scale where dispersal limitation is critical.
The contribution of this paper is to estimate the number of tree species at the regional scale, in French Guiana (8 million hectares of tropical moist forest with no ecological boundary to distinguish them from the rest of Amazonia) and demonstrate which method is valid to do so.
We build on Harte's self similarity model [@Harte1999] that implies the power-law relatioship of @Arrhenius1921 and provides a technique to evaluate its parameters [@Harte1999a], previously applied by @Krishnamani2004 in the Western Ghats, India.
We show that the log-series model underlying the work of @TerSteege2013 does not apply at the regional scale.

# Methods

Self-similarity [@Harte1999] is a property based on scale invariance.
Consider a species $s$ that is present in an area $A_0$, say French Guiana.
The probability to find it in half the whole area, denoted $A_1$ is $h_s$.
Then, if it is present $A_1$, the probability to find it in turn in half $A_1$, denoted $A_2$, is also $h_s$, and so on.
The probability to find the species in $A_n$ is $h_s^n$.
In other words, the conditional probability to find a species in a sub-area, given that it is present in the area containing it, only depends on the relative size of the sub-area (half the parent area here for simplicity): it does not depend on the observation scale.

Arrenhius's power law [@Arrhenius1921] is a consequence of the self-similarity property.
The number of species $S(A)$ observed in an area $A$ is

\begin{equation}
  S(A)=cA^z
  (\#eq:Arrhenius)
\end{equation}

where $z$ is the power parameter and $c$ is the number of species in an area of size 1.
This is a classical relation in macroecology, with long empirical and theoretical support [@GarciaMartin2006].

If $z$ is known, the inventory of a reasonably large area $a$ allows computing $c=a^z/S(a)$.
Then, $S(A)$ can be calculated for any value of $A$.

@Harte1999a showed that under the assumption of self-similarity, $z$ can be inferred from the dissimilarity between small and distant plots distributed across the area.
The @Sorensen1948 dissimilarity between two plots is

\begin{equation}
  \chi = 2 (S_1 \cap S_2) / (S_1 + S_2)
  (\#eq:Sorensen)
\end{equation}

where $S_1$ (respectively $S_2$ is the number of species in plot 1 (resp. 2) and $(S_1 \cap S_2)$ is the number of common species.

Applied to plots of the same size separated by distance $d$, Harte's relation simplifies to
\begin{equation}
  \chi \sim d^{2z}
  (\#eq:estimatez)
\end{equation}

that can be estimated by the linear model $\log(\chi) \sim 2z \log(d)$.
The logarithm of the Sorensen dissimilarity between pair of plots can be regressed against the logarithm of the distance between the plots: the slope of the regression is twice the value of $z$.

The relation \@ref(eq:estimatez) holds at the same scale as the power law, i.e. at the regional scale [@Grilli2012].
@Krishnamani2004 estimated $z \approx 0.12$ with a very good fit to the linear model at distances up from 1 km.
Their major issue was to estimate the number of species at this scale, i.e. on a square kilometer area, by extrapolating small plot data, leading them to estimate scale-dependent values of $z$ at scales where the model is arguably not valid.

A large enough inventory, provided by a permanent forest facility, is necessary along with a set of small, widely spread forest plots.

```{r Paracou}
# 3 control plots in blocks, p13-15, p16
paracou_area <- (6*6.25+25)/100
# From Paracou database
paracou_S <- 604
```

```{r FrenchGuiana}
# Extrapolation area in squared km
A0 <- 80000
```
The Paracou research station [@Gourlet-Fleury2004] is located at latitude 5°18′N and longitude 52°53′W.
It contains six 6.25-ha and one 25-ha plots of primary rainforest summing up to a compact `r paracou_area`-ha inventory that can be considered continuous at the scale of French Guiana (`r A0/1000` million hectares).

```{r Guyadiv}
library("tidyverse") %>% suppressMessages()
# Decrypt the vault
library("secret") %>% suppressMessages()
name_project <- "GF-Richness"
vault <- "vault"
Sys.setenv(USER_KEY = usethis::proj_path(paste0(name_project, ".rsa")))
# Plots: code, location, X, Y
Plots <- get_secret("Plots", vault = vault)
# Abundances of species in each plot
Abundances <- get_secret("Abundances", vault = vault)
# Number of plots
guyadiv_plots <- nrow(Plots)
# Number of locations
guyadiv_locations <- length(unique(Plots$Location))
```
**Decription of Guyadiv here**

```{r n_simulations}
# Number of simulations to run
n_simulations <- 100L
```


We take into account the `r guyadiv_plots` one-hectare plots of the network. 
They are located in `r guyadiv_locations` locations that allow a quite good coverage of the variability of the forest in French Guiana (**map here**).
The number of plots varies across locations so the estimation of $z$ must be made with care.
We sampled one random plot at each location to obtain $`r guyadiv_locations` \times `r guyadiv_locations-1`/2 = 210$ pairs of plots.
We calculated the Sorensen dissimilarity $\chi$ and the geographic distance $d$ between each pair of plots.
We estimated $z$ as half the coefficient of the distance variable in the linear model $\log(\chi) \sim \log(d)$.
We repeated these steps `r n_simulations` times to obtain a distribution of estimated $z$ values depending on the plots drawn in each location.
The empirical mean $\mu_z$ and standard devation $\sigma_z$ of the distribution were calculated.
$z$ was estimated as $\mu_z$ with a 95% confidence interval equal to $\pm t \sigma_z / \sqrt(`r n_simulations`)$.

All analyses were made with R [@R] v. 4.1.2.

# Results

```{r estimate_z}
library("ade4")
library("broom")
library("dbmss")
# estimate_z selects one random plot per location,
# estimates log(Sorensen) ~ log(Distance)
# and returns z
estimate_z <- function() {
  # Select one plot per location...
  Plots %>% 
    # Set a random value to each plot
    mutate(Random=runif(n())) -> 
    RandomizedPlots
  RandomizedPlots %>% 
    group_by(Location) %>%
    # Select the plot with the max random value in each location
    summarize(MaxRandom=max(Random)) %>% 
    rename(Random=MaxRandom) %>% 
    # Eliminate non-selected plots
    inner_join(RandomizedPlots) %>% 
    suppressMessages %>% 
    select(Plot) -> 
    SelectedPlots
  # Calculate distances
  Plots %>% 
    # Selected plots only
    inner_join(SelectedPlots) %>%
    suppressMessages %>% 
    rename(PointName=Plot, X=X_UTM, Y=Y_UTM, PointType=Location) %>% 
    mutate(PointWeight=1) %>% 
    # Create a weighted, marked planar point pattern (dbmss)
    wmppp(unitname = c("meter", "meters")) %>% 
    suppressWarnings %>% 
    # Calculate distances between pairs of plots
    pairdist() %>% 
    # Make a dist object (ade4)
    as.dist -> 
    Distances
  # Calculate Sorensen divergence
  Abundances %>% 
    # Selected plots only
    inner_join(SelectedPlots) %>% 
    suppressMessages %>% 
    select(-Plot) %>% 
    # Calculate Sorensen similarity
    dist.binary(method = 5) -> 
    Sorensen
  # Sorensen dissimilarity
  Sorensen <- 1-Sorensen
  # Regress log(Sorensen) ~ log(Distance)
  tibble(Sorensen=as.numeric(log10(Sorensen)), 
         Distance=as.numeric(log10(Distances))) %>% 
    # Distances over 1km
    dplyr::filter(Distance > 3) %>% 
    # Estimate the model
    lm(Sorensen~Distance, data=.) %>% 
    # Extract the slope
    tidy %>% 
    dplyr::filter(term == "Distance") %>% 
    select(estimate) %>% 
    pull -> 
    slope
  # z is negative half the slope
  z <- -slope/2
  return(z)
}
```

```{r bootstrap_z}
if (interactive()) {
  # Prepare a progress bar
  pgb <- txtProgressBar(min=0, max=n_simulations)
  # To store bootstrapped z values
  sim_z <- rep(0, n_simulations)
  # Run simulations
  for (i in 1:n_simulations) {
    sim_z[i] <- estimate_z()
    setTxtProgressBar(pgb, i)
  }
} else {
  # Compact code
  sim_z <- replicate(n_simulations, estimate_z())
}

# Statistics
z <- mean(sim_z)
z_sigma <- sd(sim_z)
alpha <- 0.05
z_ci <- quantile(sim_z, probs = c(alpha/2, 1-alpha/2))
# Not retained: standard error of the mean
# z_ci <- qt(1-alpha/2,
#           df=guyadiv_locations*(guyadiv_locations-1)/2 -2) *
#  z_sigma / sqrt(n_simulations)

# Plot the distribution of z
# entropart::as.SimTest(z, sim_z) %>% autoplot
```

The estimated value of $z$ is `r z %>% round(3) %>% format(nsmall=2)` with a 95% confidence interval between `r z_ci[1] %>% round(3) %>% format(nsmall=3)` and `r z_ci[2] %>% round(3) %>% format(nsmall=3)`.

```{r estimate_c}
# From Paracou data
c_est <- paracou_S/paracou_area^z
```

The number of species per squared kilometer, $c$, is `r c_est %>% round(0)`.

```{r estimate_S}
# Estimated number of species
S <- c_est * A0^z
S_ci <- c_est * A0^z_ci
```

Finally, the estimated number of species is `r S %>% round(0)`.
Taking into account the uncertainty about $z$, its 95% confidence interval is between `r S_ci[1] %>% round(0) ` and `r S_ci[2] %>% round(0)`.

# Discussion

# Appendix

## Similarity distance decay

## Random plot

One plot per location

```{r}
# One plot per location...
Plots %>% 
  mutate(Random=runif(n())) -> 
  RandomizedPlots
RandomizedPlots %>% 
  group_by(Location) %>%
  summarize(MaxRandom=max(Random)) %>% 
  rename(Random=MaxRandom) %>% 
  inner_join(RandomizedPlots) %>% 
  select(Plot) -> 
  SelectedPlots

# ...or all plots
# SelectedPlots <- Plots["Plot"]

# Distances
library("dbmss") %>% suppressMessages()
Plots %>% 
  inner_join(SelectedPlots) %>%
  rename(PointName=Plot, X=X_UTM, Y=Y_UTM, PointType=Location) %>% 
  mutate(PointWeight=1) %>% 
  wmppp(unitname = c("meter", "meters")) %>% 
  pairdist() %>% 
  as.dist -> 
  Distances
```


## Sorensen

```{r}
library("ade4") %>% suppressMessages()
Abundances %>% 
  inner_join(SelectedPlots) %>% 
  select(-Plot) %>% 
  dist.binary(method = 5) -> Sorensen
Sorensen <- 1-Sorensen
```

## Relation

```{r}
tibble(Sorensen=as.numeric(log10(Sorensen)), Distance=as.numeric(log10(Distances))) %>% 
  filter(Distance > 3) -> dist_plots
lm(Sorensen~Distance, data=dist_plots) -> regression
regression %>% summary()
(-regression$coefficients[2]/2 -> z)
dist_plots %>% 
  ggplot(aes(x=Distance, y=Sorensen)) +
    geom_point() +
    geom_smooth(method = lm)
```
## Fisher

```{r}
# Nombre d'arbres
Ntrees <- 8*10^6 * mean(colSums(Abundances[, -1]))
# Taux de couverture par placette
###########################
library("entropart") %>% suppressMessages()
C <- apply(Abundances[, -1], 1, function(X) Coverage(X))
# Distribution de probabilités, corrigée par les taux de couverture
ObsProba <- C %*% as.matrix(Abundances[, -1]/rowSums(Abundances[, -1]))/nrow(Abundances)
plot(as.ProbaVector(ObsProba))
# Abondances
EstimatedAbd <- as.AbdVector(round(ObsProba*Ntrees, 0))
# 50% centraux
EA50 <- as.AbdVector(sort(EstimatedAbd, decreasing = T)[round(length(EstimatedAbd)/4):round(length(EstimatedAbd)*3/4)])
x <- 1:length(EA50)
y <- as.numeric(log(EA50))
# Régression rang-abondance sur la partie rectiligne de la courbe
EA50lm <- lm(y ~ x)
# Nombre d'espèces extrapolé
NbSpecies <- round(-EA50lm$coefficients[1]/EA50lm$coefficients[2]) + round(length(EstimatedAbd)/4)-1
# Régression de la partie rectiligne
plot(y~x, ylim=c(0,max(y)))
summary(EA50lm)
abline(a=EA50lm$coefficients[1], b=EA50lm$coefficients[2], col="red")
# Metacommunauté complète: partie observée
EA75 <- sort(EstimatedAbd, decreasing = T)[1:round(length(EstimatedAbd)*3/4)]
plot(EstimatedAbd, ylim=c(1, max(EA75)), xlim=c(0, NbSpecies), col="grey")
points(EA75, ylim=c(1, max(EA75)), xlim=c(0,-EA50lm$coefficients[1]/EA50lm$coefficients[2]))
Extra <- exp(EA50lm$coefficients[1])*cumprod(rep(exp(EA50lm$coefficients[2]), NbSpecies-round(length(EstimatedAbd)/4)+1))
lines(x=round(length(EstimatedAbd)/4):NbSpecies, y=Extra, col="red")
# Vérification : effectif total
(Ntotal <- sum(EA75) + sum(Extra[(length(EA75)-NbSpecies+length(Extra)+1):length(Extra)]))
# Ajustement d'une log-série
plot(as.AbdVector(round(c(EA75, Extra[(length(EA75)-NbSpecies+length(Extra)+1):length(Extra)]))), Distribution = "lseries")
# Nombre d'espèces estimées
NbSpecies
```

## Hyperdominance

```{r}
# Hyperdominance
EstimatedAbd <- sort(round(ObsProba*Ntrees, 0), decreasing = TRUE)
plot(cumsum(EstimatedAbd), ylim=c(0, Ntrees))
abline(h=Ntrees/2, lty=2, col="red")
hdSpecies <- min(which(cumsum(EstimatedAbd)>Ntrees/2))
abline(v=hdSpecies, lty=2, col="red")
```

`r if (!knitr:::is_latex_output()) '# References {-}'`
